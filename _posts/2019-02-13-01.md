---
layout: post
author: Kim
title: 前端工程师需要了解的浏览器
tags: ['面试']
---

前端工程师面试的时候常常会被问到浏览器工作原理，有很多小伙伴会有疑惑，这部分知识有用？我的回答是有用，但我们要掌握学习的深度，毕竟浏览器是门大学问，我们并不用学成“浏览器开发工程师”。所以这篇文章，我们把范围圈定在“前端工程师需要了解的”程度。

我以 Chrome 完成一次页面请求为例，大致过程是这样的：

1. 浏览器 UI 线程解析输入的字符串，通知 Network 线程获取内容
1. Network 线程解析 DNS，查找主机 IP
1. 利用 HTTP 或者 HTTPS 协议请求 HTML 页面
1. 获得 HTML 字节流，断开连接
1. HTML 解释器将 HTML 字节流解析成 DOM 树
1. 计算 DOM 树上的 CSS 属性
1. 渲染获得位图，保存在内存中
1. 对位图进行合成（可选）
1. 将最后的位图绘制到浏览器界面上

下面我们对每一步做些深入了解。

### Step 1

这部分主要涉及浏览器的内核，我们稍微了解下就行。Chrome 是个多线程的浏览器，每个线程负责不同的部分，一个最大的好处就是当一个页面崩溃的时候，不会引起其他页面崩溃。缺点是比较耗资源，不过现在大部分计算机都是资源过剩，这个缺点也就被无限缩小了。

### Step 2

这步我们有一个点要知道下：Chrome 会将解析后的 DNS 缓存起来，避免每次都要去解析。

### Step 3

这步开始进入正题。HTTP 协议属于应用层，是基于传输层的 TCP 协议的，所以这里就涉及到了一个知识点：**建立 TCP 连接的三次握手**：

1. Client 向 Server 发送请求连接报文 SYN
1. Server 接到后向 Client 回复 SYN + ACK
1. Client 接到后向 Client 发送 ACK 报文

那么如果是 HTTPS 协议呢？与 HTTP 唯一的区别就是，HTTPS 会在 TCP 连接建立后，再与服务器建立一条 TLS 加密通道，将传输内容通过通道进行传输。

### Step 4

在完成请求后，我们需要断开 TCP 连接（当然也可能不断开，但我们为了体验比较完整的过程，这里就假设断开），所以需要进行 **四次挥手**：

1. Client 向 Server 发送 FIN 报文，说明要关闭连接
2. Server 向 Client 发送 ACK 报文，说明接到关闭连接的请求，正在做关闭前处理
3. Server 向 Client 发送 FIN 报文，说明开始关闭连接
4. Client 向 Server 发送 ACK 报文，确认等待关闭

### Step 5

HTML 解释器经过下面的步骤将 HTML 字节流生成 DOM 树：

1. 解释器从字节流中读取字符
1. 每读取一个字符，就放入状态机中进行词法分析
1. 词法分析会生成一个个**词（token）**
1. 多个 **token** 按照一定的规则组成 **DOM 节点**
1. **DOM** 间按照层级关系构建成 **DOM 树**

### Step 6

CSS 解释器结合 DOM 上的 CSS 属性和样式文件，对生成的 DOM 树进行**布局计算**（重排 reflow），然后将位图**绘制**（重绘 redraw）到内存。我们知道重排是比较慢的，要尽量避免。

### Step 7

将符合图层合并的图层进行合并，这有助于提升最后一步的绘制速度。

这里还有个 GPU 加速的概念，被加速的元素会独立出来，自身的变动不再影响 DOM 结构（也就是不会发生重排）。符合下面的条件之一的元素会被 GPU 加速：

- 有 `transform` 属性
- 有 `perspective` 属性
- `<video>`
- `<canvas>`
- 拥有动画属性

我们尽量让经常变动的元素处于 GPU 加速状态下。

### Step 8

将合成过后的多个图层绘制到浏览器页面上，就是我们看到的网页啦。

---

最后有一个注意点要说下，浏览器的解析过程并不是**线性**的，而是**流式**的，所以步骤 5、6、7 并不是 5 走完了走 6，6 完成了走 7，而是类似 567、567 ... 这样循环发生的。
